---
title: "Prueba de evaluaci√≥n R"
author: "Ivonne Y√°√±ez Mendoza"
fontsize: 12pt
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---

##### M√≥dulo: Programacion R

##### Profesor: Jose Luis Brita-Paja

##### Master en big data & business analytics, Universidad Complutense de Madrid

##### 26 de abril de 2022

------------------------------------------------------------------------

**Pregunta 1**


a)  Generar todos los n√∫meros que entran en el sorteo de la ONCE y mostrarlos 
con los cuatro d√≠gitos.

```{r paged.print=TRUE}
# Se genera el dato para trabajar
numeros <- c(formatC(0000:9999, width = 4, flag = '0' ))

# El resultado 
resultado <- sapply(numeros, function(x) 
          sum( as.numeric(unlist(strsplit(as.character(x), split=""))) ))

ordenado <- sort.int(resultado, decreasing = TRUE)
```

b)  ¬øCu√°l es la suma de los n√∫meros de un boleto que m√°s se repite?

```{r}
mas_repetido <- tail(names(sort(table(resultado))), 1)
sprintf("La suma de los numeros de un boleto que mas se repite es %s. ", 
        mas_repetido)
```

**Pregunta 2**

a)  Leer los archivos "datos_provincias.csv", "CodProv.txt\* y "CodCCAA.dat ". 
A√±ade el c√≥digo de la comunidad aut√≥noma al fichero "datos_provincias.csv" 
(no manualmente).

```{r paged.print=TRUE}
library(kableExtra)
# Paso 1 leer los archivos

cod_ccaa <- read.csv("CodCCAA.csv")
datos_provincias <- data.frame(read.csv("datos_provincias.csv"))
cod_provincias <- data.frame(read.table(file = "CodProv.txt", sep=",", 
                  header = TRUE, row.names = NULL))

# Paso 2 se elimina la ES de la columna Codigo del data frame cod_provincias
cod_provincias$C√≥digo <- sub("^(\\w+)-", "", cod_provincias$C√≥digo)

# Con merge se une tanto el data frame cod_provincias como datos provincias 
# para traer el codigo de la comunidad autonoma que corresponde

base_graficos <- merge(cod_provincias, datos_provincias, by.x = "C√≥digo", by.y = "provincia_iso", all.y = TRUE)
```

b)  Selecciona los datos de la comunidad aut√≥noma que te corresponda. Para saber cu√°l es tu comunidad aut√≥noma realiza la siguiente operaci√≥n

```{r}
# DNI o Pasaporte mod 17 por ejemplo (12345678 %% 17 = 6 ‚Üí Castilla y Le√≥n)

# Paso 2 seleccionar los datos de la comunidad autonoma que me corresponde.

dni <- 169728542
dni_provincias <- dni %% 17

# Seg√∫n este c√°lculo la provincia asignada es PV, pais vasco, se filtra segun 
# el c√≥digo de la comunidad aut√≥noma"
viscaya <- subset(base_graficos, Comunidad.aut√≥noma == "PV")


```

**Gr√°ficos**

c) Realizar un gr√°fico que muestre adecuadamente la evoluci√≥n de los casos 
nuevos. Justifica el gr√°fico elegido. 
Nota: Eleg√≠ este tipo de gr√°fico pues muestra de una forma visual el aumento
y decremento de los picos de casos Covid para el periodo se√±alado.

```{r}
datos <- viscaya

# Con los datos de Viscaya se genera el gr√°fico
datos$fecha <- as.Date(datos$fecha)
datos <- datos[order(datos$fecha),]


x <- datos$fecha
y <- datos$num_casos


g <- aggregate(y, by=list(casos=x), FUN=sum)

"grafico 1"

plot(g, type ="l", xlab ="Meses 2020", ylab ="Numero casos", main ="Evoluci√≥n Casos Diarios Comunidad Autonoma Viscaya", col = "blue", font = 2)
polygon(g, col = "lightblue")
grid()
axis(side= 2, font=2)


```




d)  Presenta en √∫nico gr√°fico la evoluci√≥n de las distintas variables (columnas)
por medio de un gr√°fico de l√≠neas m√∫ltiples. 
Utiliza diferentes colores y a√±ade una leyenda muestre el origen de cada l√≠nea.

```{r warning=FALSE}
"grafico 2"
plot(g, type = "s", 
     xtat = 'n', ylab = 'Numero casos', xlab = "Meses 2020",
     main = "Evolucion de casos COVID segun tipo de caso", beside = TRUE)


a <- aggregate(datos$num_casos_prueba_pcr, by=list(casos = datos$fecha), FUN = "sum")
b <- aggregate(datos$num_casos_prueba_otras, by= list(casos = datos$fecha), FUN = 'sum')
c <- aggregate(datos$num_casos_prueba_test_ac, by = list(casos = datos$fecha), FUN = 'sum')
d <- aggregate(datos$num_casos_prueba_desconocida, by = list(casos = datos$fecha), FUN = 'sum')
lines(a, col= 'red')
lines(b, col = 'blue')
lines(c, col = 'green')
lines(d,col = 'purple')

legend(x = "topleft",         # Posici√≥n
       title = "Tipo casos",
       legend = c("casos", "casos pcr", "casos otras", "casos ac", "desconocido"), # Textos de la leyenda
       lty = c(1),          # Tipo de l√≠neas
       col = c(1, 'red', 'blue', 'green', 'purple'),          # Colores de las l√≠neas
       lwd = 2)   
grid()
```

**Pregunta 3**

a)  Crear dos data frame de nombres, uno de nombre articulo leyendo 
la informaci√≥n de "articulo.xlsx" y el otro de nombre descuento que guarde la informaci√≥n de "descuento_aplicar.txt".

```{r}
library("xlsx") #Para leer archivos excel

# Paso 1 leer los datos del archivo excel y del archivo txt"
tabla_excel <- read.xlsx("articulo.xlsx", sheetIndex = 1)
descuento <- read.delim("descuento_aplicar.txt")


# Paso 2 transformar la tabla excel y el archivo de texto a un data frame
articulos <- data.frame(tabla_excel)
descuentos <- data.frame(descuento)

# C√°lculo de ingreso bruto
articulos$ingreso_bruto <- articulos$PVP * articulos$CANTIDAD 

articulos <- articulos[order(articulos$ingreso_bruto, decreasing = TRUE),]
print(head(articulos))
```

b)  Crear una variable llamada tipo que clasifique los art√≠culos en los tipos A, B y C en la forma indicada y a√±adirlo al data frame art√≠culo y calcula, en una √∫nica sentencia, el total de ingresos brutos por cada tipo de art√≠culo.

```{r}
# Calcula deciles para utilizarlos en el c√°lculo del tipo de descuento

deciles <- quantile(articulos$ingreso_bruto,probs = seq(.1, .9, by = .1))

# Asigna tramo de descuento seg√∫n ingreso bruto y decil
articulos$tipo <- with(articulos, ifelse(ingreso_bruto >= 6108000, 'A',
                                  ifelse(ingreso_bruto > 1797000 & ingreso_bruto < 6108000, "B",
                                  ifelse(ingreso_bruto <= 1797000, "C", 0))))

# Ordena el data frame de mayor a menor ingreso bruto
articulos <- articulos[order(articulos$ingreso_bruto, decreasing = TRUE), ]
print(head(articulos))
```

c)  Unir los dos data frame, articulo y descuento, de forma adecuada, para crear el data frame clientes. Calcular la variable nuevo_pvp = pvp -- cantidad a descontar. Suponiendo que el volumen de ventas se mantiene constante dar una estimaci√≥n del porcentaje de decremento en los ingresos brutos al aplicar los descuentos.

```{r}

# Se unen los data frame articulos y descuento para crear el df clientes en el paso posterior
articulos2 <- articulos
articulos3 <- merge(articulos, descuento, by.x = "tipo", by.y = "tipo", all.x = TRUE)


# Crea el data frame clientes"

clientes <- articulos3
print(head(clientes))

```

```{r paged.print=TRUE}
# Calcular la variable nuevo_pvp con el % de descuento correspondiente segun tramo"
clientes$nuevo_pvp <- with(clientes,ifelse(tipo == "A", clientes$PVP * 0.9,
                                             ifelse(tipo == "B", clientes$PVP * 0.85, 
                                            ifelse(tipo == "C", clientes$PVP * 0.8, 0))))

# Crea una nueva columna donde calcula el ingreso bruto por art√≠culo con los valores actualizados"
clientes$n_ingreso_bruto <- clientes$CANTIDAD * clientes$nuevo_pvp

# Se realiza el c√°lculo de decremento"

decremento <- round(100 - ((sum(clientes$n_ingreso_bruto) / sum(clientes$ingreso_bruto)) * 100 ), digits = 2)
paste0("El porcentaje de decremento corresponde a un ", decremento, "%", ".")


```

**Pregunta 4**

1.  Para la semana S7, calcule el vector (ùëì1,1‚àíùëì1,ùëì2,1‚àíùëì2,ùëì3,1‚àíùëì3,ùëì4,1‚àíùëì4) donde ùëìùëñ es la frecuencia (relativa) de la modalidad ùëñ‚àà{1,2,3,4} observada en la semana ùëÜ7 sobre los 16 sujetos. (Sugerencia: use las funciones tabulate(), cbind(), t()y as.vector()). Ahora, use la funci√≥n apply() para hacer el mismo c√°lculo para todas las dem√°s semanas. Almacene el resultado en una matriz.

```{r}

# Leer el archivo 
fichero <- source("matriz.R")
fichero <- fichero[[1]]

print(fichero)

# El primer paso es limpiar y organizar los datos
# La variable base tiene por objetivo contar la cantidad de ocurrencias de los niveles y rellena con 0 en caso de no hallar coincidencias

base <- apply(fichero, 2, function(i) table(factor(i, levels = c(1:4))))

#Se elimina la columna 1 pues no se utilizar√° para los c√°lculos y la tabla esta lista para trabajar
base <- base[,-1] 
print(base)

# En una variable se calcula el total de registros que tiene la tabla, son 16
# Es preferible calcularla en caso que se desee reutilizar este script
registros <- nrow(fichero)
print(registros)

#Se realiza el c√°lculo de frecuencias relativas para la matriz y se agregan nombres a las columnas 

matriz <- base / registros
colnames(matriz) <- c("s1", "s2", "s3", "s4", "s5", "s6", "s7")

print(matriz)

# Tomando como base la matriz, se crea una nueva para calcular la resta del 1 a las frecuencias

matriz2 <- matrix(unlist(lapply(1, `-`, matriz)), ncol = 7, nrow=4)
row.names(matriz2) <- c("1", "2", "3", "4")
print(matriz2)

# Una vez listas ambas matrices es momento de combinarlas para generar la base del gr√°fico
data <- rbind(matriz, matriz2)
data <- data[ order(as.numeric(row.names(data))), ]
print(data)

```

2.  Utilice la funci√≥n barplot() y el argumento col = c ("black", "white") en esta matriz. El gr√°fico que se obtiene ofrece una descripci√≥n general de la evoluci√≥n de la Sensaci√≥n de ardor con el tiempo.

```{r}
# Generaci√≥n de gr√°fico para evaluar la sensaci√≥n de ardor con el tiempo

par(mar = c(5, 5, 5, 5))
original <- barplot(data,
        ylim=c(0,4),
        main="Evoluci√≥n de la sensaci√≥n de ardor con el tiempo",
        xlab='Semanas',
        ylab='Frecuencia relativa',
        col = c ("black", "white")
)

```

3.  Cambie el gr√°fico anterior para que las barras que representan las frecuencias est√©n en rojo. Los n√∫meros de las semanas deben estar en azul y en la parte superior del gr√°fico en lugar del fondo. Los n√∫meros

```{r}
# Generaci√≥n de gr√°fico para evaluar la sensaci√≥n de ardor con el tiempo con los cambios solicitados

# Amplia el margen de la hoja del gr√°fico
par(mar = c(5, 5, 5, 5))
cambios <- barplot(data,
        ylim=c(0,4),
        xaxt = 'n',
        col = c ("red", "white"),
        col.axis = "blue",
        font.axis = 2,

      
)

title("Evoluci√≥n de la sensaci√≥n de ardor con el tiempo", line = 3.5)
# Asigna los n√∫meroas de las semanas a la parte superior del gr√°fico
axis(3, at = seq(from = 0.7, to = 7.9,by = 1.2),labels = c("s1", "s2", "s3", "s4","s5", "s6", "s7"), 
     col.axis = "blue", font.axis = 2, tick = FALSE)


```
